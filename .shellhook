#!/usr/bin/env bash

export WD=$PWD

for x in bin build out; do
    if [ ! -d "$WD/$x" ]; then
        mkdir "$WD/$x"
    fi
done

export flags=(
    "-ferror-limit=1"
    -fshort-enums
    -funsigned-char
    "-march=native"
    -O1
    "-std=gnu11"
    -Werror
    -Weverything
    -Wno-c++98-compat
    -Wno-cast-align
    -Wno-covered-switch-default
    -Wno-declaration-after-statement
    -Wno-extra-semi-stmt
    -Wno-padded
    -Wno-reserved-identifier
    -Wno-vla
)
export flags_sanitize=(
    "-fsanitize=address"
    "-fsanitize=bounds"
    "-fsanitize=float-divide-by-zero"
    "-fsanitize=implicit-conversion"
    "-fsanitize=integer"
    "-fsanitize=nullability"
    "-fsanitize=undefined"
)
libs=(
    -lm
    -lX11
    -pthread
)

runc () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    clang-format -i -verbose "$1" || return
    pwd_=$PWD
    cp "$1" "$WD/build/$handle.c"
    (
        cd "$WD/build" || return
        clang \
            -g \
            -o "$WD/bin/${handle}_valgrind" \
            "${flags[@]}" \
            "${libs[@]}" \
            "$handle.c" \
            || return
        clang \
            -o "$WD/bin/${handle}_sanitize" \
            "${flags[@]}" \
            "${flags_sanitize[@]}" \
            "${libs[@]}" \
            "$handle.c" \
            || return
        cd "$pwd_" || return
        if [ -z "$2" ]; then
            "$WD/bin/${handle}_sanitize"
        else
            "$WD/bin/${handle}_sanitize" "$2"
        fi
    )
}

export -f runc

alias feh="feh --force-aliasing"
