#!/usr/bin/env bash

export WD=$PWD

for x in bin build out; do
    if [ ! -d "$WD/$x" ]; then
        mkdir "$WD/$x"
    fi
done

export FLAGS=(
    "-ferror-limit=1"
    "-fsanitize=address"
    "-fsanitize=bounds"
    "-fsanitize=float-divide-by-zero"
    "-fsanitize=implicit-conversion"
    "-fsanitize=integer"
    "-fsanitize=nullability"
    "-fsanitize=undefined"
    -fshort-enums
    -funsigned-char
    -lcrypto
    -lm
    -lssl
    -lX11
    "-march=native"
    -O1
    -pthread
    "-std=gnu11"
    -Werror
    -Weverything
    -Wno-c++98-compat
    -Wno-cast-align
    -Wno-covered-switch-default
    -Wno-declaration-after-statement
    -Wno-extra-semi-stmt
    -Wno-padded
    -Wno-pointer-arith
    -Wno-reserved-identifier
    -Wno-unsafe-buffer-usage
    -Wno-vla
)

runc () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    clang-format -i -verbose "$1" || return
    cp "$1" "$WD/build/$handle.c"
    if $(
        cd "$WD/build" || return
        clang -o "$WD/bin/${handle}" "${FLAGS[@]}" "$handle.c"
    ); then
        if [ -z "$2" ]; then
            "$WD/bin/${handle}"
        else
            "$WD/bin/${handle}" "$2"
        fi
    fi
}

export -f runc

alias feh="feh --force-aliasing"
alias shellcheck="shellcheck -e SC2091"
