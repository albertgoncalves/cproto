#!/usr/bin/env bash

export WD=$PWD

for x in bin build out; do
    if [ ! -d "$WD/$x" ]; then
        mkdir "$WD/$x"
    fi
done

export FLAGS=(
    -fdelete-null-pointer-checks
    -fshort-enums
    -O1
    "-std=gnu99"
    -Wall
    -Wcast-align
    "-Wcast-align=strict"
    -Wcast-qual
    -Wconversion
    -Wdate-time
    -Wdouble-promotion
    -Wduplicated-branches
    -Wduplicated-cond
    -Werror
    -Wextra
    -Wfatal-errors
    -Wfloat-equal
    "-Wformat=2"
    -Wformat-signedness
    -Winline
    -Wlogical-op
    -Wmissing-declarations
    -Wmissing-include-dirs
    -Wmissing-prototypes
    -Wnested-externs
    -Wnull-dereference
    -Wpacked
    -Wpedantic
    -Wpointer-arith
    -Wredundant-decls
    -Wshadow
    -Wstack-protector
    -Wstrict-prototypes
    -Wswitch-enum
    -Wtrampolines
    -Wundef
    -Wunused
    -Wunused-macros
    -Wwrite-strings
)

runc () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    clang-format -i "$1" || return
    pin=$PWD
    cp "$1" "$WD/build/$handle.c"
    (
        cd "$WD/build" || return
        gcc -g "${FLAGS[@]}" "$handle.c" -o "$WD/bin/$handle" || return
        cd "$pin" || return
        if [ -z "$2" ]; then
            "$WD/bin/$handle"
        else
            "$WD/bin/$handle" "$2"
        fi
    )
}

open () {
    sxiv "$1" > /dev/null 2>&1
}

export -f runc
export -f open
