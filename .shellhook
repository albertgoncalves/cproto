#!/usr/bin/env bash

if [ "$(uname -s)" = "Darwin" ]; then
    alias ls="ls --color=auto"
    alias ll="ls -l"
else
    alias open="xdg-open"
fi

export WD=$PWD

for x in "$WD/bin" "$WD/build"; do
    if [ ! -d "$x" ]; then
        mkdir "$x"
    fi
done

export FLAGS=(
    "-std=c99" \
    "-ferror-limit=1" \
    -O1 \
    -Werror \
    -Wall \
    -Wextra \
    -Wconversion \
    -Wsign-conversion \
    -Wunused \
    -Wunused-function \
    -Wunused-label \
    -Wunused-macros \
    -Wunused-parameter \
    -Wunused-value \
    -Wunused-variable \
    -Wcast-align \
    -Wcast-qual \
    -Wmissing-declarations \
    -Wredundant-decls \
    -Wmissing-prototypes \
    -Wnested-externs \
    -Wpointer-arith \
    -Wshadow \
    -Wstrict-prototypes \
    -Wwrite-strings \
    -Wswitch \
    -Wmissing-field-initializers \
    -pedantic-errors
)

runc () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    clang-format -i "$1" || return
    cp "$1" "$WD/build/$handle.c"
    (
        cd "$WD/build" || return
        clang "${FLAGS[@]}" "$handle.c" -o "$WD/bin/$handle" || return
        "$WD/bin/$handle"
    )
}

export -f runc
