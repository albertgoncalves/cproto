#!/usr/bin/env bash

export WD=$PWD

for x in "$WD/bin" "$WD/build"; do
    if [ ! -d "$x" ]; then
        mkdir "$x"
    fi
done

export FLAGS=(
    -Os \
    -Wall \
    -Wbad-function-cast \
    -Wcast-align \
    "-Wcast-align=strict" \
    -Wcast-qual \
    -Wconversion \
    -Wdate-time \
    -Wdouble-promotion \
    -Wduplicated-branches \
    -Wduplicated-cond \
    -Werror \
    -Wextra \
    -Wfatal-errors \
    -Wfloat-equal \
    -Wformat-signedness \
    "-Wformat=2" \
    -Winline \
    -Wlogical-op \
    -Wmissing-declarations \
    -Wmissing-include-dirs \
    -Wmissing-prototypes \
    -Wnested-externs \
    -Wnull-dereference \
    -Wpacked \
    -Wpedantic \
    -Wpointer-arith \
    -Wredundant-decls \
    -Wshadow \
    -Wstack-protector \
    -Wstrict-prototypes \
    -Wswitch-enum \
    -Wtrampolines \
    -Wundef \
    -Wunused \
    -Wunused-macros \
    -Wwrite-strings \
    -fdelete-null-pointer-checks \
    "-std=gnu99"
)

runc () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    clang-format -i "$1" || return
    pin=$PWD
    cp "$1" "$WD/build/$handle.c"
    (
        cd "$WD/build" || return
        gcc "${FLAGS[@]}" "$handle.c" -o "$WD/bin/$handle" || return
        cd "$pin" || return
        if [ -z "$2" ]; then
            "$WD/bin/$handle"
        else
            "$WD/bin/$handle" "$2"
        fi
    )
}

export -f runc
